# 关于加密流量

在加密流量问世之后，破解和监控加密流量的声音就不绝于耳。在常见的加密流量中，主要分为了两种，一种是 firefox 或 chrome 等浏览器流量，另一种是使用命令行实现 SSL 加密通信。

firefox 会使用 libnspr4.so 动态链接库，当然这要视具体系统版本和浏览器版本而定。经过实验测试得到，firefox 会使用该库中的 `PR_Read` 和 `PR_Write` 函数用于加密通信。不管是哪个动态链接库，他们都属于用户态，因此需要使用用户探针进行监控。其重点是要找到应用程序用于通信的库函数。

以下两个步骤展示了如何获取 firefox 对 libnspr 库的使用信息，其他应用对动态链接库的使用情况同理。

## 获取链接库中包含的库函数

这一部分非常简单，可以使用 readelf 工具来读取动态链接库中声明的库函数，命令如下：

```shell
readelf -Ws /usr/lib64/libnspr4.so
```

## 获取应用的库函数调用

在 Linux 中，strace 是常用的系统调用跟踪工具，它可以跟踪一个应用程序调用的系统调用情况。而对于动态链接库中的库函数调用，可以使用 ltrace 工具来查看。

例如，如果希望查看 firefox 调用 libnspr4.so 库中 PR_Read 和 PR_Write 的情况，可以使用以下命令：

```shell
ltrace -f -l @libnspr* -x PR_Read+PR_Write -o firefox-ltrace.txt /usr/lib64/firefox/firefox
```

其中 `-f` 选项表示跟踪子进程，`-l` 选项代表只跟踪指定的链接库，`@libnspr*` 代表通配符，@ 前是库中包含的函数，之后是跟踪的链接库的模式。`-x` 是希望监控的库函数的名称，支持通配符，如果监控多个函数，使用 ‘+’，如果想排除某个函数或库，使用 ‘-’。`-o` 选项指定将 ltrace 工具的输出保存到文件中。